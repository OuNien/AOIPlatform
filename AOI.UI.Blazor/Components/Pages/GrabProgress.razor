@page "/grab-progress"
@inject IHttpClientFactory ClientFactory

<h3>Grab Progress</h3>

@if (isLoading)
{
        <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
        <p class="text-danger">@errorMessage</p>
}
else
{
        <div class="mb-3">
            <label>Select Batch:</label>
            <select @onchange="OnBatchChanged" class="form-select" style="width:250px;">
            @foreach (var batch in batchList)
            {
                        <option value="@batch.BatchId">@batch.BatchId</option>
            }
            </select>
        </div>

        <button class="btn btn-primary" @onclick="Refresh">Refresh</button>

    @if (current != null)
    {
                <div class="mt-4">
                    <h5>Top Side</h5>
                    <p>@current.TopCompletedPanels / @current.TopExpectedPanels</p>

                    <h5>Bottom Side</h5>
                    <p>@current.BottomCompletedPanels / @current.BottomExpectedPanels</p>
                </div>
    }
}

@code {

    // ---------------------------
    // Data Models
    // ---------------------------
    public class GrabBatchSummary
    {
        public string BatchId { get; set; } = "";
    }

    public class GrabProgressDto
    {
        public string BatchId { get; set; } = "";
        public int TopExpectedPanels { get; set; }
        public int TopCompletedPanels { get; set; }
        public int BottomExpectedPanels { get; set; }
        public int BottomCompletedPanels { get; set; }
    }


    // ---------------------------
    // Fields
    // ---------------------------
    private bool isLoading = true;
    private string? errorMessage;

    private List<GrabBatchSummary> batchList = new();
    private GrabProgressDto? current;

    private string? selectedBatchId;


    // ---------------------------
    // Lifecycle
    // ---------------------------
    protected override async Task OnInitializedAsync()
    {
        await LoadBatchList();
        await LoadCurrentBatch();
    }


    // ---------------------------
    // API Calls
    // ---------------------------
    private async Task LoadBatchList()
    {
        try
        {
            isLoading = true;

            var client = ClientFactory.CreateClient("GrabApi");

            var result = await client.GetFromJsonAsync<List<GrabBatchSummary>>(
                "api/GrabStatus/batches");

            batchList = result ?? new List<GrabBatchSummary>();

            selectedBatchId = batchList.FirstOrDefault()?.BatchId;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed loading batch list: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }


    private async Task LoadCurrentBatch()
    {
        if (string.IsNullOrEmpty(selectedBatchId))
            return;

        try
        {
            var client = ClientFactory.CreateClient("GrabApi");

            current = await client.GetFromJsonAsync<GrabProgressDto>(
                $"api/GrabStatus/batches/{selectedBatchId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed loading current batch: {ex.Message}";
        }
    }


    // ---------------------------
    // UI Events
    // ---------------------------
    private async Task OnBatchChanged(ChangeEventArgs e)
    {
        selectedBatchId = e.Value?.ToString();
        await LoadCurrentBatch();
    }

    private async Task Refresh()
    {
        await LoadCurrentBatch();
    }
}
